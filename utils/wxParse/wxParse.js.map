{"version":3,"sources":["utils/wxParse/wxParse.js"],"names":["wxParse","bindName","type","data","target","imagePadding","that","transData","html2json","console","log","JSON","stringify","converter","Converter","html","makeHtml","view","bindData","setData","wxParseImgLoad","wxParseImgTap","e","nowImgUrl","dataset","src","tagFrom","from","length","wx","previewImage","current","urls","imageUrls","idx","calMoreImageInfo","temData","images","temImages","recal","wxAutoImageCal","detail","width","height","imageWidth","imageheight","originalWidth","originalHeight","windowWidth","windowHeight","autoWidth","autoHeight","results","getSystemInfo","success","res","padding","wxParseTemArray","temArrayName","bindNameReg","total","array","obj","i","simArr","nodes","push","parse","emojisInit","reg","baseSrc","emojis","module","exports"],"mappings":"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","file":"wxParse.js","sourcesContent":["/**\r\n * author: Di (微信小程序开发工程师)\r\n * organization: WeAppDev(微信小程序开发论坛)(http://weappdev.com)\r\n *               垂直微信小程序开发交流社区\r\n * github地址: https://github.com/icindy/wxParse\r\n * for: 微信小程序富文本解析\r\n * detail : http://weappdev.com/t/wxparse-alpha0-1-html-markdown/184\r\n */\r\n\r\n/**\r\n * utils函数引入\r\n **/\r\n/*eslint-disable */\r\nimport showdown from './showdown.js';\r\nimport HtmlToJson from './html2json.js';\r\n/**\r\n * 配置及公有属性\r\n **/\r\n/**\r\n * 主函数入口区\r\n **/\r\nfunction wxParse(bindName = 'wxParseData', type='html', data='<div class=\"color:red;\">数据不能为空</div>', target,imagePadding) {\r\n  var that = target;\r\n  var transData = {};//存放转化后的数据\r\n  if (type == 'html') {\r\n    transData = HtmlToJson.html2json(data, bindName);\r\n    console.log(JSON.stringify(transData, ' ', ' '));\r\n  } else if (type == 'md' || type == 'markdown') {\r\n    var converter = new showdown.Converter();\r\n    var html = converter.makeHtml(data);\r\n    transData = HtmlToJson.html2json(html, bindName);\r\n    console.log(JSON.stringify(transData, ' ', ' '));\r\n  }\r\n  transData.view = {};\r\n  transData.view.imagePadding = 0;\r\n  if(typeof(imagePadding) != 'undefined'){\r\n    transData.view.imagePadding = imagePadding\r\n  }\r\n  var bindData = {};\r\n  bindData[bindName] = transData;\r\n  that.setData(bindData)\r\n  that.wxParseImgLoad = wxParseImgLoad;\r\n  that.wxParseImgTap = wxParseImgTap;\r\n}\r\n// 图片点击事件\r\nfunction wxParseImgTap(e) {\r\n  var that = this;\r\n  var nowImgUrl = e.target.dataset.src;\r\n  var tagFrom = e.target.dataset.from;\r\n  if (typeof (tagFrom) != 'undefined' && tagFrom.length > 0) {\r\n    wx.previewImage({\r\n      current: nowImgUrl, // 当前显示图片的http链接\r\n      urls: that.data[tagFrom].imageUrls // 需要预览的图片http链接列表\r\n    })\r\n  }\r\n}\r\n\r\n/**\r\n * 图片视觉宽高计算函数区 \r\n **/\r\nfunction wxParseImgLoad(e) {\r\n  var that = this;\r\n  var tagFrom = e.target.dataset.from;\r\n  var idx = e.target.dataset.idx;\r\n  if (typeof (tagFrom) != 'undefined' && tagFrom.length > 0) {\r\n    calMoreImageInfo(e, idx, that, tagFrom)\r\n  } \r\n}\r\n// 假循环获取计算图片视觉最佳宽高\r\nfunction calMoreImageInfo(e, idx, that, bindName) {\r\n  var temData = that.data[bindName];\r\n  if (temData.images.length == 0) {\r\n    return;\r\n  }\r\n  var temImages = temData.images;\r\n  //因为无法获取view宽度 需要自定义padding进行计算，稍后处理\r\n  var recal = wxAutoImageCal(e.detail.width, e.detail.height,that,bindName); \r\n  temImages[idx].width = recal.imageWidth;\r\n  temImages[idx].height = recal.imageheight; \r\n  temData.images = temImages;\r\n  var bindData = {};\r\n  bindData[bindName] = temData;\r\n  that.setData(bindData);\r\n}\r\n\r\n// 计算视觉优先的图片宽高\r\nfunction wxAutoImageCal(originalWidth, originalHeight,that,bindName) {\r\n  //获取图片的原始长宽\r\n  var windowWidth = 0, windowHeight = 0;\r\n  var autoWidth = 0, autoHeight = 0;\r\n  var results = {};\r\n  wx.getSystemInfo({\r\n    success: function (res) {\r\n      var padding = that.data[bindName].view.imagePadding;\r\n      windowWidth = res.windowWidth-2*padding;\r\n      windowHeight = res.windowHeight;\r\n      //判断按照那种方式进行缩放\r\n      console.log(\"windowWidth\" + windowWidth);\r\n      if (originalWidth > windowWidth) {//在图片width大于手机屏幕width时候\r\n        autoWidth = windowWidth;\r\n        console.log(\"autoWidth\" + autoWidth);\r\n        autoHeight = (autoWidth * originalHeight) / originalWidth;\r\n        console.log(\"autoHeight\" + autoHeight);\r\n        results.imageWidth = autoWidth;\r\n        results.imageheight = autoHeight;\r\n      } else {//否则展示原来的数据\r\n        results.imageWidth = originalWidth;\r\n        results.imageheight = originalHeight;\r\n      }\r\n    }\r\n  })\r\n  return results;\r\n}\r\n\r\nfunction wxParseTemArray(temArrayName,bindNameReg,total,that){\r\n  var array = [];\r\n  var temData = that.data;\r\n  var obj = null;\r\n  for(var i = 0; i < total; i++){\r\n    var simArr = temData[bindNameReg+i].nodes;\r\n    array.push(simArr);\r\n  }\r\n\r\n  temArrayName = temArrayName || 'wxParseTemArray';\r\n  obj = JSON.parse('{\"'+ temArrayName +'\":\"\"}');\r\n  obj[temArrayName] = array;\r\n  that.setData(obj);\r\n}\r\n\r\n/**\r\n * 配置emojis\r\n * \r\n */\r\n\r\nfunction emojisInit(reg='',baseSrc=\"/wxParse/emojis/\",emojis){\r\n   HtmlToJson.emojisInit(reg,baseSrc,emojis);\r\n}\r\n\r\nmodule.exports = {\r\n  wxParse: wxParse,\r\n  wxParseTemArray:wxParseTemArray,\r\n  emojisInit:emojisInit\r\n}\r\n/*eslint-enable */\r\n"]}