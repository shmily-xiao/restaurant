{"version":3,"sources":["pages/search/search.js"],"names":["app","getApp","useUrl","require","Page","data","title","nearShop","search","searchText","history","chooseHistory","searchShow","star","cleanHistory","setData","wx","removeStorageSync","chooseTip","e","index","currentTarget","dataset","choose","searchShop","searcheText","type","detail","value","showModal","content","showCancel","replace","length","that","count","unshift","pop","setStorage","key","success","getStorageSync","searchInput","keyword","obj","url","serviceUrl","session_key","longitude","latitude","res","requestInfo","onLoad","onReady","onShow","onHide","onUnload","onPullDownRefresh"],"mappings":"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","file":"search.js","sourcesContent":["// 获取全局应用程序实例对象\r\nconst app = getApp()\r\nconst useUrl = require('../../utils/service')\r\n// 创建页面实例对象\r\nPage({\r\n  /**\r\n   * 页面的初始数据\r\n   */\r\n  data: {\r\n    title: 'search',\r\n    nearShop: [\r\n      // {\r\n      //   img: 'http://img02.tooopen.com/images/20150928/tooopen_sy_143912755726.jpg',\r\n      //   name: '青花椒砂锅鱼',\r\n      //   price: '30',\r\n      //   kind: '中国菜',\r\n      //   distance: '8.6km',\r\n      //   status: '无需排队',\r\n      //   grade: 'five-star'\r\n      // },\r\n      // {\r\n      //   img: 'http://img02.tooopen.com/images/20150928/tooopen_sy_143912755726.jpg',\r\n      //   name: '青花椒砂锅鱼',\r\n      //   price: '30',\r\n      //   kind: '中国菜',\r\n      //   status: '无需排队',\r\n      //   grade: 'four-star'\r\n      // },\r\n      // {\r\n      //   img: 'http://img02.tooopen.com/images/20150928/tooopen_sy_143912755726.jpg',\r\n      //   name: '青花椒砂锅鱼',\r\n      //   price: '128',\r\n      //   kind: '中国菜',\r\n      //   status: '无需排队',\r\n      //   grade: 'one-star'\r\n      // },\r\n      // {\r\n      //   img: 'http://img02.tooopen.com/images/20150928/tooopen_sy_143912755726.jpg',\r\n      //   name: '青花椒砂锅鱼',\r\n      //   price: '128',\r\n      //   kind: '中国菜',\r\n      //   status: '无需排队',\r\n      //   grade: 'one-star'\r\n      // },\r\n      // {\r\n      //   img: 'http://img02.tooopen.com/images/20150928/tooopen_sy_143912755726.jpg',\r\n      //   name: '青花椒砂锅鱼',\r\n      //   price: '128',\r\n      //   kind: '中国菜',\r\n      //   status: '无需排队',\r\n      //   grade: 'one-star'\r\n      // },\r\n      // {\r\n      //   img: 'http://img02.tooopen.com/images/20150928/tooopen_sy_143912755726.jpg',\r\n      //   name: '青花椒砂锅鱼',\r\n      //   price: '128',\r\n      //   kind: '中国菜',\r\n      //   status: '无需排队',\r\n      //   grade: 'one-star'\r\n      // },\r\n      // {\r\n      //   img: 'http://img02.tooopen.com/images/20150928/tooopen_sy_143912755726.jpg',\r\n      //   name: '青花椒砂锅鱼',\r\n      //   price: '128',\r\n      //   kind: '中国菜',\r\n      //   status: '无需排队',\r\n      //   grade: 'one-star'\r\n      // },\r\n      // {\r\n      //   img: 'http://img02.tooopen.com/images/20150928/tooopen_sy_143912755726.jpg',\r\n      //   name: '青花椒砂锅鱼',\r\n      //   price: '128',\r\n      //   kind: '中国菜',\r\n      //   status: '无需排队',\r\n      //   grade: 'one-star'\r\n      // }\r\n    ],\r\n    search: false,\r\n    searchText: null,\r\n    history: [],\r\n    chooseHistory: null,\r\n    searchShow: true,\r\n    star: ['zero-star', 'one-star', 'two-star', 'three-star', 'four-star', 'five-star']\r\n  },\r\n  /**\r\n   * 清空搜索记录\r\n   */\r\n  cleanHistory () {\r\n    this.setData({\r\n      history: [],\r\n      searchShow: false\r\n    })\r\n    wx.removeStorageSync('history')\r\n  },\r\n  /**\r\n   * 改变标签选择\r\n   * @param e\r\n   */\r\n  chooseTip (e) {\r\n    let index = e.currentTarget.dataset.choose\r\n    this.setData({\r\n      chooseHistory: index\r\n    })\r\n    this.search(this.data.history[index])\r\n  },\r\n  /**\r\n   * 搜索返回\r\n   */\r\n  searchShop (e) {\r\n    let searcheText = null\r\n    if (e.currentTarget.dataset.type === 'btn') {\r\n      // 按钮搜索\r\n      // console.log(this.data.searchText)\r\n      searcheText = this.data.searchText\r\n    } else {\r\n      // 打字框搜索\r\n      // console.log(e.detail.value)\r\n      searcheText = e.detail.value\r\n    }\r\n    if (!searcheText) {\r\n      wx.showModal({\r\n        title: '饭店搜索',\r\n        content: '请输入你要搜索的饭店名称',\r\n        showCancel: false\r\n      })\r\n      this.setData({\r\n        searchText: ''\r\n      })\r\n      return\r\n    }\r\n    searcheText = searcheText.replace(/\\s+/g, '')\r\n    // console.log(searcheText.length)\r\n    if (!searcheText.length) {\r\n      wx.showModal({\r\n        title: '饭店搜索',\r\n        content: '请输入你要搜索的饭店名称',\r\n        showCancel: false\r\n      })\r\n      this.setData({\r\n        searchText: ''\r\n      })\r\n      return\r\n    }\r\n    let that = this\r\n    // 设置缓存\r\n    for (var index in that.data.history) {\r\n      // 搜索项已经存在\r\n      if (that.data.history[index] === searcheText) {\r\n        // console.log(index)\r\n        that.setData({\r\n          chooseHistory: index\r\n        })\r\n        that.search(that.data.history[index])\r\n        return\r\n      }\r\n    }\r\n    let history = that.data.history\r\n    // console.log(history)\r\n    if (!history) {\r\n      history = [searcheText]\r\n      that.data.history = history\r\n    } else {\r\n      let count = history.unshift(searcheText)\r\n      if (count >= 10) {\r\n        that.data.history.pop()\r\n      }\r\n    }\r\n    this.setData({\r\n      chooseHistory: 0,\r\n      searchShow: true\r\n    })\r\n    this.search(searcheText)\r\n    wx.setStorage({\r\n      key: 'history',\r\n      data: that.data.history,\r\n      success () {\r\n        that.setData({\r\n          history: wx.getStorageSync('history')\r\n        })\r\n      }\r\n    })\r\n  },\r\n  /**\r\n   * 键盘输入改变搜索结果\r\n   */\r\n  searchInput (e) {\r\n    // console.log(e.detail.value)\r\n    this.setData({\r\n      searchText: e.detail.value\r\n    })\r\n  },\r\n  /**\r\n   * 搜索操作\r\n   */\r\n  search (keyword) {\r\n    let that = this\r\n    let obj = {\r\n      url: useUrl.serviceUrl.search,\r\n      data: {\r\n        session_key: wx.getStorageSync('session_key'),\r\n        keyword: keyword,\r\n        longitude: wx.getStorageSync('userSite').longitude,\r\n        latitude: wx.getStorageSync('userSite').latitude\r\n      },\r\n      success (res) {\r\n        // console.log(res)\r\n        that.setData({\r\n          search: true\r\n        })\r\n        if (res.data.data.length === 0) return\r\n        that.setData({\r\n          nearShop: res.data.data\r\n        })\r\n      }\r\n    }\r\n    app.requestInfo(obj)\r\n  },\r\n  /**\r\n   * 生命周期函数--监听页面加载\r\n   */\r\n  onLoad () {\r\n    // 读取搜索历史\r\n    let history = wx.getStorageSync('history')\r\n    if (!history) {\r\n      this.setData({\r\n        searchShow: false\r\n      })\r\n    }\r\n    this.setData({\r\n      history: history\r\n    })\r\n    // TODO: onLoad\r\n  },\r\n\r\n  /**\r\n   * 生命周期函数--监听页面初次渲染完成\r\n   */\r\n  onReady () {\r\n    // TODO: onReady\r\n  },\r\n\r\n  /**\r\n   * 生命周期函数--监听页面显示\r\n   */\r\n  onShow () {\r\n    // TODO: onShow\r\n  },\r\n\r\n  /**\r\n   * 生命周期函数--监听页面隐藏\r\n   */\r\n  onHide () {\r\n    // TODO: onHide\r\n  },\r\n\r\n  /**\r\n   * 生命周期函数--监听页面卸载\r\n   */\r\n  onUnload () {\r\n    // TODO: onUnload\r\n  },\r\n\r\n  /**\r\n   * 页面相关事件处理函数--监听用户下拉动作\r\n   */\r\n  onPullDownRefresh () {\r\n    // TODO: onPullDownRefresh\r\n  }\r\n})\r\n"]}